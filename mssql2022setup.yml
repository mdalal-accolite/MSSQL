---
- hosts: windows
  tasks:
  - name: Create directory structure
    win_file:
      path: C:\MSSQL2022
      path: C:\SSMS
      state: directory

  - name: Copy File
    win_copy:
      src: 'setupfiles/'
      dest: C:\MSSQL2022\
      remote_src: no

  - name: Run remote PowerShell Script
    win_command: powershell.exe -ExecutionPolicy ByPass -File C:\MSSQL2022\sqlconfig.ps1
    
  - name: Run multi-lined shell commands
    win_shell: |
        $configfile = "C:\MSSQL2022\configuration.ini"
        $command = "E:\setup.exe /Q /IACCEPTSQLSERVERLICENSETERMS /ConfigurationFile=$($configfile)"
        Invoke-Expression -Command $command        
                
  - name: Run multi-lined shell commands
    win_shell: |
        net stop 'MSSQL$SQL2022' /y
        net stop 'SQLTELEMETRY$SQL2022'
        net stop 'SQLWriter'
        net start 'MSSQL$SQL2022'
        net start 'SQLAgent$SQL2022'
        Invoke-Sqlcmd -ServerInstance hostname\SQL2022  -InputFile "C:\MSSQL2022\saenb.sql"
        
  - name: Run multi-lined shell commands
    win_shell: |
        Start-Process C:\SSMS\SSMS-Setup.exe -ArgumentList '/install','/passive', '/promptrestart' -Wait        
        Restart-Computer -Force
